<section id="launch" class="mt-10 rounded-2xl border border-white/10 bg-white/5 p-6 md:p-8">
  <h2 class="text-lg font-semibold text-white/90">Get launch access</h2>
  <p class="mt-2 max-w-2xl text-sm leading-6 text-white/75">
    Get the launch packet: timeline, wallet onboarding, and public release notes.
  </p>

  <form
  id="signup-form"
  class="mt-5 flex flex-col gap-3 sm:flex-row"
  novalidate
>
  <input
    type="email"
    name="email"
    required
    placeholder="you@domain.com"
    class="w-full flex-1 rounded-xl border border-white/10 bg-black/30 px-4 py-2.5 text-sm text-white/90 placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-cyan-300/30"
  />

  <input
    type="text"
    name="name"
    placeholder="Name (optional)"
    class="w-full flex-1 rounded-xl border border-white/10 bg-black/30 px-4 py-2.5 text-sm text-white/90 placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-cyan-300/30"
  />

  <select
    name="role"
    class="w-full rounded-xl border border-white/10 bg-black/30 px-4 py-2.5 text-sm text-white/80 focus:outline-none focus:ring-2 focus:ring-cyan-300/30 sm:w-44"
  >
    <option value="user">I’m a user</option>
    <option value="merchant">I’m a merchant</option>
    <option value="builder">I’m a builder</option>
  </select>

  <!-- honeypot (keep hidden) -->
  <input
    type="text"
    name="hp"
    tabindex="-1"
    autocomplete="off"
    style="display:none"
  />

  <button
    type="submit"
    class="rounded-xl bg-cyan-400/15 px-4 py-2.5 text-sm font-semibold text-cyan-200 ring-1 ring-cyan-300/25 hover:bg-cyan-400/20"
  >
    Notify me
  </button>
</form>

<p id="signup-status" class="mt-3 text-xs text-white/60" aria-live="polite"></p>
<div class="mt-2 text-xs text-white/45">
  We’ll only email you about launch access.
</div>
<script type="module">
  function wireSignup() {
    const form = document.getElementById("signup-form");
    const status = document.getElementById("signup-status");
    if (!form || !status) return;

    // prevent duplicate handlers (Astro navigation / hot reload)
    if (form.dataset.bound === "1") return;
    form.dataset.bound = "1";

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.textContent = "";

      const fd = new FormData(form);

      const email = String(fd.get("email") || "").trim();
      const name = String(fd.get("name") || "").trim();
      const role = String(fd.get("role") || "").trim();
      const hp = String(fd.get("hp") || "").trim();

      if (!email) {
        status.textContent = "Please enter an email.";
        return;
      }

      // optional: disable button while submitting
      const btn = form.querySelector('button[type="submit"]');
      if (btn) btn.setAttribute("disabled", "disabled");

      try {
        const res = await fetch("/api/signup", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            email,
            name: name || undefined,
            source: `thesisweb.com:${role || "unknown"}`,
            hp,
          }),
        });

        if (res.ok) {
          status.textContent = "Thanks — you’re on the list.";
          form.reset();
        } else if (res.status === 429) {
          status.textContent = "Too many attempts. Try again in a minute.";
        } else if (res.status === 502 || res.status === 503 || res.status === 504) {
          status.textContent = "Signup temporarily unavailable. Try again later.";
        } else {
          status.textContent = "Something went wrong. Try again later.";
        }
      } catch {
        status.textContent = "Network error. Please try again.";
      } finally {
        if (btn) btn.removeAttribute("disabled");
      }
    });
  }

  wireSignup();
  document.addEventListener("astro:page-load", wireSignup);
</script>

</section>
